<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Bots (Carga Lenta Manual + Persistencia)</title>
    <style>
        /* Estilos CSS (Se mantienen sin cambios) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* Contenedor Principal */
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        /* Secci贸n de Configuraci贸n */
        .configuracion {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 150px;
            font-family: monospace;
            grid-column: 1 / -1;
        }

        /* Bot贸n principal */
        .btn-actualizar {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-actualizar:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .btn-actualizar:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        /* Bot贸n de Carga de Lotes */
        #loadNextBatchButton {
            margin-top: 20px;
            background-color: #2ecc71;
            transition: background-color 0.3s ease;
        }

        #loadNextBatchButton:hover:not(:disabled) {
            background-color: #27ae60;
        }

        /* Dashboard (Grid de Iframes) */
        #dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .iframe-container {
            position: relative;
            padding-top: 75%;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            background-color: #fafafa;
            transition: all 0.3s ease;
        }

        .iframe-container.loading::before {
            content: 'Cargando...';
            color: #3498db;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.7);
        }

        .iframe-container.loaded,
        .iframe-container.placeholder {
            cursor: pointer;
        }
        
        .iframe-container.placeholder {
             border: 2px dashed #bdc3c7;
             background-color: #ecf0f1;
        }
        
        .iframe-container.placeholder::before {
            content: 'Listo para cargar';
            color: #7f8c8d;
        }

        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            visibility: hidden;
        }

        .iframe-container.loaded iframe {
            visibility: visible;
        }

        /*  BOTN CLARO PARA ABRIR */
        .open-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(52,152,219,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .iframe-container.loaded:hover .open-btn {
            opacity: 1;
        }
        
        .iframe-container.placeholder .open-btn {
            display: none;
        }


        /* --- MODAL con Edici贸n --- */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            position: relative;
            width: 95vw;
            height: 95vh;
            background: #fff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        #modal-editor {
            padding: 10px;
            background: #f1f1f1;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #modal-editor label {
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }
        
        #modal-editor input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        #modal-editor button {
             background-color: #e67e22;
             color: white;
             padding: 8px 15px;
             border: none;
             border-radius: 4px;
             font-weight: 600;
             cursor: pointer;
             transition: background-color 0.3s;
        }

        #modal-editor button:hover {
            background-color: #d35400;
        }


        .modal-close {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }

        #modal-iframe-holder {
            flex-grow: 1;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            overflow: hidden;
        }

        #modal-iframe-holder iframe {
            width: 100%;
            height: 100%;
            border: 0;
            visibility: visible;
            position: static;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard de Bots (Carga Lenta Manual + Persistencia)</h1>

        <div class="configuracion">
            <div class="form-group">
                <label for="baseUrl">Enlace Base (Ej: https://sitioweb.com/app)</label>
                <input type="text" id="baseUrl" value="https://hyperdice.pasino.com/" />
            </div>

            <div class="form-group">
                <label for="totalToLoad">Total de Ventanas a Crear</label>
                <input type="number" id="totalToLoad" value="36" />
            </div>

            <div class="form-group">
                <label for="batchSize">Cargar en Lotes de:</label>
                <input type="number" id="batchSize" value="6" />
            </div>

            <div class="form-group">
                <label for="tokens">Lista de Tokens (uno por l铆nea)</label>
                <textarea id="tokens" placeholder="Pega tu lista de tokens aqu铆, uno por l铆nea..."></textarea>
            </div>
        </div>
        
        <button id="startButton" class="btn-actualizar">1. Crear Contenedores</button>
        <button id="loadNextBatchButton" class="btn-actualizar" style="display: none;">2. Cargar Siguiente Lote (0/0)</button>
        
        <div id="status-message"></div>
        <div id="dashboard-grid"></div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <span id="modal-close" class="modal-close">&times;</span>
            
            <div id="modal-editor">
                <label for="current-url-input">Link Completo:</label>
                <input type="text" id="current-url-input" placeholder="URL completa del bot (para edici贸n y recarga)" />
                <button id="update-iframe-button">Actualizar Bot</button>
            </div>
            
            <div id="modal-iframe-holder"></div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Referencias principales
            const baseUrlInput = document.getElementById("baseUrl");
            const tokensTextarea = document.getElementById("tokens");
            const totalToLoadInput = document.getElementById("totalToLoad");
            const batchSizeInput = document.getElementById("batchSize");
            const startButton = document.getElementById("startButton");
            const loadNextBatchButton = document.getElementById("loadNextBatchButton");
            const dashboardGrid = document.getElementById("dashboard-grid");
            const statusMessage = document.getElementById("status-message");
            
            // Referencias del Modal
            const modalOverlay = document.getElementById("modal-overlay");
            const modalIframeHolder = document.getElementById("modal-iframe-holder");
            const modalClose = document.getElementById("modal-close");
            const currentUrlInput = document.getElementById("current-url-input");
            const updateIframeButton = document.getElementById("update-iframe-button");

            let allPlaceholders = [];
            let currentBatchIndex = 0;
            let originalParent = null;

            // ----------------------------------------------------
            //  FUNCIONES DE EDICIN Y MODAL
            // ----------------------------------------------------

            function updateIframe() {
                const newUrl = currentUrlInput.value.trim();
                const iframe = modalIframeHolder.querySelector("iframe");

                if (!newUrl || !iframe) return;

                const parentContainer = iframe.closest('.iframe-container');
                
                if(parentContainer) {
                    parentContainer.classList.remove('loaded');
                    parentContainer.classList.add('loading');
                }
                
                iframe.src = newUrl;
                // Guardamos la nueva URL en data-src, ya sea manual o por actualizaci贸n
                iframe.setAttribute('data-src', newUrl); 
                
                iframe.onload = () => {
                     if(parentContainer) {
                        parentContainer.classList.remove('loading');
                        parentContainer.classList.add('loaded');
                     }
                };
            }
            
            function openModal(container) {
                const iframe = container.querySelector("iframe");
                
                if (iframe) {
                    originalParent = container;
                    
                    // Al abrir: Intentamos cargar la URL ACTUAL del iframe en el input de edici贸n.
                    let currentUrl = iframe.getAttribute('data-src') || iframe.src;
                    try {
                        // Intentamos obtener la URL de navegaci贸n REAL dentro del iframe
                        if (iframe.contentWindow && iframe.contentWindow.location.href) {
                            currentUrl = iframe.contentWindow.location.href;
                        }
                    } catch (e) {
                        // Fallo por Same-Origin Policy. Usamos la data-src o src
                        console.warn("No se pudo obtener la URL actual del iframe (Same-Origin Policy). Usando URL guardada.");
                    }
                    
                    currentUrlInput.value = currentUrl;
                    
                    modalIframeHolder.appendChild(iframe);
                    modalOverlay.classList.add("visible");
                }
            }

            function closeModal() {
                const iframe = modalIframeHolder.querySelector("iframe");
                if (iframe && originalParent) {
                    let finalUrl = currentUrlInput.value.trim(); // URL del input (por si el usuario la edit贸)
                    
                    // 1. **CLAVE DEL CAMBIO**: Intentar obtener la URL actual del iframe.
                    try {
                        if (iframe.contentWindow && iframe.contentWindow.location.href) {
                            // Si se puede acceder, la URL actual del iframe (despu茅s de navegar) es la que se guarda
                            finalUrl = iframe.contentWindow.location.href;
                            currentUrlInput.value = finalUrl; // Opcional: actualizar el input antes de cerrar
                        }
                    } catch (e) {
                         // Fallo por Same-Origin Policy. finalUrl sigue siendo la del input de edici贸n (o el valor inicial al abrir).
                    }
                    
                    // 2. Guardar la URL (navegada o editada) en el data-src para la pr贸xima vez
                    iframe.setAttribute('data-src', finalUrl);

                    // 3. Devolver el iframe
                    originalParent.appendChild(iframe);
                    
                    modalOverlay.classList.remove("visible");
                    originalParent = null;
                }
            }
            
            // ----------------------------------------------------
            //  LGICA DE CARGA LENTA MANUAL (Sin Cambios Relevantes)
            // ----------------------------------------------------
            
            function createPlaceholders(tokens, baseUrl) {
                 dashboardGrid.innerHTML = "";
                 allPlaceholders = [];
                 currentBatchIndex = 0;
                 loadNextBatchButton.style.display = 'none';
                 startButton.disabled = true;
                 startButton.textContent = "Creando Contenedores...";
                 statusMessage.textContent = `Preparando ${tokens.length} contenedores...`;

                 for (let i = 0; i < tokens.length; i++) {
                    const token = tokens[i];
                    
                    const base = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
                    const separator = base.includes('?') ? '&' : '?';
                    const url = `${base}${separator}token=${encodeURIComponent(token)}`;

                    const iframeContainer = document.createElement("div");
                    iframeContainer.className = "iframe-container placeholder";
                    iframeContainer.setAttribute("data-token-index", i);

                    const iframe = document.createElement("iframe");
                    iframe.setAttribute("data-src", url);
                    iframe.setAttribute("frameborder", "0");
                    iframe.setAttribute("loading", "lazy");

                    const openBtn = document.createElement("button");
                    openBtn.className = "open-btn";
                    openBtn.innerHTML = "";
                    
                    openBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if(iframeContainer.classList.contains('loaded')) {
                             openModal(iframeContainer);
                        }
                    });

                    iframeContainer.appendChild(openBtn);
                    iframeContainer.appendChild(iframe);
                    dashboardGrid.appendChild(iframeContainer);
                    allPlaceholders.push(iframeContainer);
                 }
                 
                 statusMessage.style.color = "#3498db";
                 statusMessage.textContent = `Contenedores creados. Total: ${tokens.length}. Listo para cargar lotes.`;
                 startButton.disabled = false;
                 startButton.textContent = "1. Crear Contenedores";
                 loadNextBatchButton.style.display = 'block';
                 updateLoadBatchButton();
            }

            async function loadNextBatch() {
                const batchSize = parseInt(batchSizeInput.value, 10) || 1;
                const totalBots = allPlaceholders.length;
                const startIndex = currentBatchIndex;
                const endIndex = Math.min(startIndex + batchSize, totalBots);

                if (startIndex >= totalBots) {
                    statusMessage.style.color = "#27ae60";
                    statusMessage.textContent = `隆Carga completa! Se cargaron ${totalBots} bots.`;
                    loadNextBatchButton.disabled = true;
                    loadNextBatchButton.textContent = "Carga Completa";
                    return;
                }
                
                loadNextBatchButton.disabled = true;
                loadNextBatchButton.textContent = `Cargando lote... (${endIndex}/${totalBots})`;
                statusMessage.textContent = `Cargando lote (Bots ${startIndex + 1} al ${endIndex})...`;

                const batch = allPlaceholders.slice(startIndex, endIndex);

                const loadPromises = batch.map(container => {
                    return new Promise(resolve => {
                        const iframe = container.querySelector("iframe");
                        container.classList.remove("placeholder");
                        container.classList.add("loading");
                        
                        iframe.src = iframe.dataset.src;

                        iframe.onload = () => {
                            container.classList.remove("loading");
                            container.classList.add("loaded");
                            resolve();
                        };
                        iframe.onerror = () => {
                            container.classList.remove("loading");
                            container.classList.add("error");
                            container.style.borderColor = "red";
                            resolve();
                        };
                    });
                });

                await Promise.all(loadPromises);
                
                currentBatchIndex = endIndex;
                updateLoadBatchButton();
                statusMessage.textContent = `Lote cargado. Total cargados: ${currentBatchIndex} de ${totalBots}.`;
            }

            function updateLoadBatchButton() {
                const totalBots = allPlaceholders.length;
                const remaining = totalBots - currentBatchIndex;
                const batchSize = parseInt(batchSizeInput.value, 10) || 1;
                
                if (currentBatchIndex >= totalBots) {
                    loadNextBatchButton.disabled = true;
                    loadNextBatchButton.textContent = "Carga Completa";
                    return;
                }
                
                const nextLoadCount = Math.min(batchSize, remaining);
                loadNextBatchButton.disabled = false;
                loadNextBatchButton.textContent = `2. Cargar Siguiente Lote (${currentBatchIndex}/${totalBots} - Cargar ${nextLoadCount})`;
            }

            // ----------------------------------------------------
            //  EVENT LISTENERS
            // ----------------------------------------------------

            startButton.addEventListener("click", () => {
                const baseUrl = baseUrlInput.value.trim();
                const totalToLoad = parseInt(totalToLoadInput.value, 10) || 0;

                let tokens = tokensTextarea.value.split("\n").map(t => t.trim()).filter(t => t);

                if (tokens.length === 1 && totalToLoad > 1) {
                    tokens = Array(totalToLoad).fill(tokens[0]);
                }
                
                const tokensToLoad = tokens.slice(0, totalToLoad);

                if (!tokensToLoad.length || !baseUrl || totalToLoad === 0) {
                    alert("Por favor, revisa la configuraci贸n (URL, Tokens, Total > 0).");
                    return;
                }
                
                createPlaceholders(tokensToLoad, baseUrl);
            });
            
            loadNextBatchButton.addEventListener("click", loadNextBatch);

            updateIframeButton.addEventListener('click', updateIframe);
            currentUrlInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                     e.preventDefault();
                     updateIframe();
                 }
            });
            modalClose.addEventListener("click", closeModal);
            modalOverlay.addEventListener("click", e => {
                if (e.target === modalOverlay) closeModal();
            });
        });
    </script>
</body>
</html>